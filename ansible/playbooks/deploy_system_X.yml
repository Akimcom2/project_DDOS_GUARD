---
- name: Deploy Prometheus Node Exporter, MariaDB, MySQL Exporter and configure NFTABLES on Debian 12
  hosts: all
  become: yes
  gather_facts: true

  tasks:
    - name: Install required packages for Prometheus Node Exporter
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      loop:
        - unzip
        - wget

    - name: Download Prometheus Node Exporter binary
      get_url:
        url: https://github.com/prometheus/node_exporter/releases/download/v1.4.0/node_exporter-1.4.0.linux-amd64.tar.gz
        dest: /tmp/node_exporter.tar.gz
        mode: 0644

    - name: Extract Prometheus Node Exporter archive
      unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /opt/
        remote_src: yes

    - name: Copy Prometheus Node Exporter binary to bin folder
      copy:
        src: /opt/node_exporter-1.4.0.linux-amd64/node_exporter
        dest: /usr/local/bin/node_exporter
        mode: 0755

    - name: Create SystemD service file for Prometheus Node Exporter
      template:
        src: templates/node_exporter.service.j2
        dest: /etc/systemd/system/node_exporter.service
        owner: root
        group: root
        mode: 0644

    - name: Start and enable Prometheus Node Exporter service
      systemd:
        name: node_exporter
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Install MariaDB Server
      apt:
        name: mariadb-server
        state: present
        update_cache: yes

    - name: Secure MariaDB installation
      shell: |
        mysql -u root -p$(cat /etc/mysql/debian.cnf | grep password | cut -d'=' -f2) -e "UPDATE mysql.user SET Password=PASSWORD('{{ mariadb_root_password }}') WHERE User='root'; FLUSH PRIVILEGES;"
      args:
        executable: /bin/bash

    - name: Add MySQL Exporter user
      mysql_user:
        name: exporter
        password: supersecret
        priv: '*.*:PROCESS,REPLICATION CLIENT'
        state: present

    - name: Download MySQL Exporter binary
      get_url:
        url: https://github.com/prometheus/mysqld_exporter/releases/download/v0.14.0/mysqld_exporter-0.14.0.linux-amd64.tar.gz
        dest: /tmp/mysqld_exporter.tar.gz
        mode: 0644

    - name: Extract MySQL Exporter archive
      unarchive:
        src: /tmp/mysqld_exporter.tar.gz
        dest: /opt/
        remote_src: yes

    - name: Copy MySQL Exporter binary to bin folder
      copy:
        src: /opt/mysqld_exporter-0.14.0.linux-amd64/mysqld_exporter
        dest: /usr/local/bin/mysqld_exporter
        mode: 0755

    - name: Create MySQL Exporter configuration file
      template:
        src: templates/mysqld_exporter.cnf.j2
        dest: /etc/mysqld_exporter.cnf
        owner: root
        group: root
        mode: 0600

    - name: Create SystemD service file for MySQL Exporter
      template:
        src: templates/mysqld_exporter.service.j2
        dest: /etc/systemd/system/mysqld_exporter.service
        owner: root
        group: root
        mode: 0644

    - name: Start and enable MySQL Exporter service
      systemd:
        name: mysqld_exporter
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Install NFTABLES package
      apt:
        name: nftables
        state: present
        update_cache: yes

    - name: Enable and start NFTABLES service
      systemd:
        name: nftables
        enabled: yes
        state: started

    - name: Configure basic NFTABLES firewall rules
      blockinfile:
        path: /etc/nftables.conf
        content: |
          flush ruleset

          table inet filter {
              chain input {
                  type filter hook input priority 0;

                  ct state established,related accept
                  iif lo accept
                  ip saddr {{ trusted_network }} accept
                  tcp dport ssh accept

                  reject with icmp type port-unreachable
              }
          }